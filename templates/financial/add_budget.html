{% extends 'base.html' %}
{% block title %}Add Budget - TaxiTracker Pro{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto animate-fade-in">
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center mb-6">
            <i data-lucide="target" class="w-8 h-8 text-green-600 mr-3"></i>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create Budget</h1>
                <p class="text-gray-600">Set financial targets and track performance</p>
            </div>
        </div>
        
        <form method="POST" class="space-y-6">
            <!-- Budget Period -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Budget Period</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="period_type" class="block text-sm font-medium text-gray-700 mb-2">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>Period Type
                        </label>
                        <select name="period_type" id="period_type" required 
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                onchange="updatePeriodFields()">
                            <option value="">Select period</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div id="month_selector" class="hidden">
                        <label for="budget_month" class="block text-sm font-medium text-gray-700 mb-2">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>Month
                        </label>
                        <select name="budget_month" id="budget_month" 
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if i == current_month %}selected{% endif %}>
                                {{ calendar_month_name[i] }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="budget_year" class="block text-sm font-medium text-gray-700 mb-2">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>Year
                        </label>
                        <select name="budget_year" id="budget_year" required 
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            {% for year in range(current_year - 1, current_year + 3) %}
                            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div id="custom_period" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="period_start" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" name="period_start" id="period_start" 
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="period_end" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" name="period_end" id="period_end" 
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
            </div>

            <!-- Budget Categories -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Budget Categories</h3>
                
                <!-- Revenue Budget -->
                <div class="mb-6">
                    <h4 class="text-md font-semibold text-green-700 mb-3 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>Revenue Targets
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="revenue_target" class="block text-sm font-medium text-gray-700 mb-2">Total Revenue Target (SEK)</label>
                            <input type="number" name="revenue_target" id="revenue_target" step="0.01" min="0" required 
                                   placeholder="Monthly revenue goal"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="trips_target" class="block text-sm font-medium text-gray-700 mb-2">Trip Count Target</label>
                            <input type="number" name="trips_target" id="trips_target" min="0" 
                                   placeholder="Expected number of trips"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                </div>
                
                <!-- Expense Budget -->
                <div class="mb-6">
                    <h4 class="text-md font-semibold text-red-700 mb-3 flex items-center">
                        <i data-lucide="trending-down" class="w-5 h-5 mr-2"></i>Expense Limits
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="fuel_budget" class="block text-sm font-medium text-gray-700 mb-2">Fuel Budget (SEK)</label>
                            <input type="number" name="fuel_budget" id="fuel_budget" step="0.01" min="0" 
                                   placeholder="Monthly fuel allowance"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="maintenance_budget" class="block text-sm font-medium text-gray-700 mb-2">Maintenance Budget (SEK)</label>
                            <input type="number" name="maintenance_budget" id="maintenance_budget" step="0.01" min="0" 
                                   placeholder="Vehicle maintenance"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="insurance_budget" class="block text-sm font-medium text-gray-700 mb-2">Insurance Budget (SEK)</label>
                            <input type="number" name="insurance_budget" id="insurance_budget" step="0.01" min="0" 
                                   placeholder="Insurance costs"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="license_budget" class="block text-sm font-medium text-gray-700 mb-2">Licensing Budget (SEK)</label>
                            <input type="number" name="license_budget" id="license_budget" step="0.01" min="0" 
                                   placeholder="Permits and licenses"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="marketing_budget" class="block text-sm font-medium text-gray-700 mb-2">Marketing Budget (SEK)</label>
                            <input type="number" name="marketing_budget" id="marketing_budget" step="0.01" min="0" 
                                   placeholder="Advertising and marketing"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="other_budget" class="block text-sm font-medium text-gray-700 mb-2">Other Expenses (SEK)</label>
                            <input type="number" name="other_budget" id="other_budget" step="0.01" min="0" 
                                   placeholder="Miscellaneous expenses"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                </div>
                
                <!-- Payroll Budget -->
                <div>
                    <h4 class="text-md font-semibold text-blue-700 mb-3 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2"></i>Payroll Budget
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="driver_payroll_budget" class="block text-sm font-medium text-gray-700 mb-2">Driver Payroll (SEK)</label>
                            <input type="number" name="driver_payroll_budget" id="driver_payroll_budget" step="0.01" min="0" 
                                   placeholder="Total driver payments"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="bonus_budget" class="block text-sm font-medium text-gray-700 mb-2">Bonus Pool (SEK)</label>
                            <input type="number" name="bonus_budget" id="bonus_budget" step="0.01" min="0" 
                                   placeholder="Performance bonuses"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Summary -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-900 mb-4">Budget Summary</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-sm text-blue-700 font-medium">Total Revenue Target</p>
                        <p id="summary_revenue" class="text-2xl font-bold text-blue-900">0 SEK</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-blue-700 font-medium">Total Expense Budget</p>
                        <p id="summary_expenses" class="text-2xl font-bold text-blue-900">0 SEK</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-blue-700 font-medium">Projected Profit</p>
                        <p id="summary_profit" class="text-2xl font-bold text-blue-900">0 SEK</p>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-sm text-blue-600">Profit Margin: <span id="profit_margin" class="font-semibold">0%</span></p>
                </div>
            </div>

            <!-- Budget Notes -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Budget Notes</h3>
                <div>
                    <label for="budget_notes" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>Additional Notes
                    </label>
                    <textarea name="budget_notes" id="budget_notes" rows="4" 
                              placeholder="Add any specific goals, assumptions, or conditions for this budget..."
                              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('financial_planning') }}" 
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-200">
                    Cancel
                </a>
                <button type="button" onclick="saveDraft()" 
                        class="px-4 py-2 border border-green-300 rounded-md text-sm font-medium text-green-700 hover:bg-green-50 transition duration-200">
                    Save Draft
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-medium transition duration-200 hover-scale">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Create Budget
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function updatePeriodFields() {
    const periodType = document.getElementById('period_type').value;
    const monthSelector = document.getElementById('month_selector');
    const customPeriod = document.getElementById('custom_period');
    
    if (periodType === 'monthly') {
        monthSelector.classList.remove('hidden');
        customPeriod.classList.add('hidden');
        document.getElementById('budget_month').required = true;
    } else if (periodType === 'custom') {
        monthSelector.classList.add('hidden');
        customPeriod.classList.remove('hidden');
        document.getElementById('budget_month').required = false;
        document.getElementById('period_start').required = true;
        document.getElementById('period_end').required = true;
    } else {
        monthSelector.classList.add('hidden');
        customPeriod.classList.add('hidden');
        document.getElementById('budget_month').required = false;
        document.getElementById('period_start').required = false;
        document.getElementById('period_end').required = false;
    }
}

function updateBudgetSummary() {
    // Revenue
    const revenueTarget = parseFloat(document.getElementById('revenue_target').value) || 0;
    
    // Expenses
    const fuelBudget = parseFloat(document.getElementById('fuel_budget').value) || 0;
    const maintenanceBudget = parseFloat(document.getElementById('maintenance_budget').value) || 0;
    const insuranceBudget = parseFloat(document.getElementById('insurance_budget').value) || 0;
    const licenseBudget = parseFloat(document.getElementById('license_budget').value) || 0;
    const marketingBudget = parseFloat(document.getElementById('marketing_budget').value) || 0;
    const otherBudget = parseFloat(document.getElementById('other_budget').value) || 0;
    const driverPayrollBudget = parseFloat(document.getElementById('driver_payroll_budget').value) || 0;
    const bonusBudget = parseFloat(document.getElementById('bonus_budget').value) || 0;
    
    const totalExpenses = fuelBudget + maintenanceBudget + insuranceBudget + licenseBudget + 
                         marketingBudget + otherBudget + driverPayrollBudget + bonusBudget;
    const profit = revenueTarget - totalExpenses;
    const profitMargin = revenueTarget > 0 ? ((profit / revenueTarget) * 100).toFixed(1) : 0;
    
    // Update display
    document.getElementById('summary_revenue').textContent = formatCurrency(revenueTarget);
    document.getElementById('summary_expenses').textContent = formatCurrency(totalExpenses);
    document.getElementById('summary_profit').textContent = formatCurrency(profit);
    document.getElementById('profit_margin').textContent = profitMargin + '%';
    
    // Color coding for profit
    const profitElement = document.getElementById('summary_profit');
    if (profit >= 0) {
        profitElement.className = 'text-2xl font-bold text-green-600';
    } else {
        profitElement.className = 'text-2xl font-bold text-red-600';
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('sv-SE', {
        style: 'currency',
        currency: 'SEK',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function saveDraft() {
    const formData = new FormData(document.querySelector('form'));
    formData.append('save_draft', 'true');
    
    fetch(window.location.pathname, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            alert('Budget draft saved successfully');
        } else {
            alert('Error saving draft');
        }
    });
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    updatePeriodFields();
    updateBudgetSummary();
    
    // Add event listeners for budget calculation
    const budgetFields = ['revenue_target', 'fuel_budget', 'maintenance_budget', 'insurance_budget', 
                         'license_budget', 'marketing_budget', 'other_budget', 'driver_payroll_budget', 'bonus_budget'];
    
    budgetFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateBudgetSummary);
        }
    });
});
</script>
{% endblock %}