{% extends 'base.html' %}
{% block title %}Data Export - TaxiTracker Pro{% endblock %}
{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i data-lucide="download" class="w-8 h-8 text-blue-600 mr-3"></i>
                    Data Export
                </h1>
                <p class="text-gray-600 mt-2">Export your business data for analysis, backup, or compliance</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500">Export formats: CSV, JSON</p>
                <p class="text-sm text-gray-500">Data includes current company only</p>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
        <!-- Contracts Export -->
        {% if current_user.role in ['owner', 'manager'] %}
        <div class="bg-white rounded-lg shadow-lg p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                    <i data-lucide="file-signature" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Employment Contracts</h3>
                    <p class="text-sm text-gray-600">Driver contracts and terms</p>
                </div>
            </div>
            
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Export all employment contracts with complete terms and conditions.</p>
                
                <div class="flex space-x-2">
                    <a href="{{ url_for('export_contracts', format='csv') }}" 
                       class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>CSV
                    </a>
                    <a href="{{ url_for('export_contracts', format='json') }}" 
                       class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="braces" class="w-4 h-4 inline mr-2"></i>JSON
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Income Export -->
        <div class="bg-white rounded-lg shadow-lg p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                    <i data-lucide="trending-up" class="w-6 h-6 text-green-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Income Data</h3>
                    <p class="text-sm text-gray-600">Revenue and trip information</p>
                </div>
            </div>
            
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Export income records with trip details and earnings.</p>
                
                <!-- Date Range Filter -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <form id="income-export-form" class="space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">From</label>
                                <input type="date" id="income-start-date" name="start_date" 
                                       class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">To</label>
                                <input type="date" id="income-end-date" name="end_date" 
                                       class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="exportIncome('csv')" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>CSV
                    </button>
                    <button onclick="exportIncome('json')" 
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="braces" class="w-4 h-4 inline mr-2"></i>JSON
                    </button>
                </div>
            </div>
        </div>

        <!-- Expenses Export -->
        <div class="bg-white rounded-lg shadow-lg p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <i data-lucide="trending-down" class="w-6 h-6 text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Expense Data</h3>
                    <p class="text-sm text-gray-600">Business expenses and receipts</p>
                </div>
            </div>
            
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Export expense records for tax and accounting purposes.</p>
                
                <!-- Date Range Filter -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <form id="expense-export-form" class="space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">From</label>
                                <input type="date" id="expense-start-date" name="start_date" 
                                       class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">To</label>
                                <input type="date" id="expense-end-date" name="end_date" 
                                       class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="exportExpenses('csv')" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>CSV
                    </button>
                    <button onclick="exportExpenses('json')" 
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-center text-sm font-medium transition duration-200">
                        <i data-lucide="braces" class="w-4 h-4 inline mr-2"></i>JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Information -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex items-start">
            <i data-lucide="info" class="w-6 h-6 text-blue-600 mr-3 mt-1 flex-shrink-0"></i>
            <div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Export Information</h3>
                <div class="space-y-2 text-sm text-blue-800">
                    <p><strong>CSV Format:</strong> Ideal for spreadsheet applications (Excel, Google Sheets). Easy to read and analyze.</p>
                    <p><strong>JSON Format:</strong> Perfect for developers and system integrations. Preserves all data relationships.</p>
                    <p><strong>Data Privacy:</strong> Exports include only data you have permission to access based on your role.</p>
                    <p><strong>Date Ranges:</strong> Leave date fields empty to export all available data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export History -->
    {% if current_user.role in ['owner', 'manager'] %}
    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="history" class="w-5 h-5 text-gray-600 mr-2"></i>
            Recent Export Activity
        </h3>
        
        <div class="space-y-3">
            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                <div class="flex items-center">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4 text-green-600 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Income Data Export</p>
                        <p class="text-xs text-gray-500">CSV format • 2024-08-24 14:30</p>
                    </div>
                </div>
                <span class="text-xs text-gray-500">1,245 records</span>
            </div>
            
            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                <div class="flex items-center">
                    <i data-lucide="braces" class="w-4 h-4 text-gray-600 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Contracts Export</p>
                        <p class="text-xs text-gray-500">JSON format • 2024-08-23 09:15</p>
                    </div>
                </div>
                <span class="text-xs text-gray-500">12 records</span>
            </div>
            
            <div class="text-center py-4">
                <p class="text-sm text-gray-500">Export history is logged for audit purposes</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function exportIncome(format) {
    const startDate = document.getElementById('income-start-date').value;
    const endDate = document.getElementById('income-end-date').value;
    
    let url = `/export/income?format=${format}`;
    if (startDate) url += `&start_date=${startDate}`;
    if (endDate) url += `&end_date=${endDate}`;
    
    // Show loading state
    event.target.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Exporting...';
    event.target.disabled = true;
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = true;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Reset button state
    setTimeout(() => {
        const icon = format === 'csv' ? 'file-spreadsheet' : 'braces';
        event.target.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 inline mr-2"></i>${format.toUpperCase()}`;
        event.target.disabled = false;
        lucide.createIcons();
    }, 2000);
}

function exportExpenses(format) {
    const startDate = document.getElementById('expense-start-date').value;
    const endDate = document.getElementById('expense-end-date').value;
    
    let url = `/export/expenses?format=${format}`;
    if (startDate) url += `&start_date=${startDate}`;
    if (endDate) url += `&end_date=${endDate}`;
    
    // Show loading state
    event.target.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Exporting...';
    event.target.disabled = true;
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = true;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Reset button state
    setTimeout(() => {
        const icon = format === 'csv' ? 'file-spreadsheet' : 'braces';
        event.target.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 inline mr-2"></i>${format.toUpperCase()}`;
        event.target.disabled = false;
        lucide.createIcons();
    }, 2000);
}

// Set default date ranges (current month)
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    const startDateStr = firstDay.toISOString().split('T')[0];
    const endDateStr = lastDay.toISOString().split('T')[0];
    
    document.getElementById('income-start-date').value = startDateStr;
    document.getElementById('income-end-date').value = endDateStr;
    document.getElementById('expense-start-date').value = startDateStr;
    document.getElementById('expense-end-date').value = endDateStr;
});
</script>
{% endblock %}