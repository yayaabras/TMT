{% extends 'base.html' %}
{% block title %}Advanced Reports - TaxiTracker Pro{% endblock %}
{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i data-lucide="bar-chart-3" class="w-8 h-8 text-purple-600 mr-3"></i>
                    Advanced Reports
                </h1>
                <p class="text-gray-600 mt-2">Comprehensive business intelligence and analytics</p>
            </div>
            <div class="text-right">
                <button onclick="generateCustomReport()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 hover-scale">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>Custom Report
                </button>
            </div>
        </div>
    </div>

    <!-- Report Filters -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Report Filters</h2>
            <button onclick="resetFilters()" class="text-sm text-gray-600 hover:text-gray-900">Reset All</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label for="date_range" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <select id="date_range" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                        onchange="updateDateRange()">
                    <option value="this_month">This Month</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_quarter">This Quarter</option>
                    <option value="last_quarter">Last Quarter</option>
                    <option value="this_year">This Year</option>
                    <option value="last_year">Last Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div id="custom_date_start" class="hidden">
                <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" id="start_date" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
            </div>
            
            <div id="custom_date_end" class="hidden">
                <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" id="end_date" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
            </div>
            
            <div>
                <label for="driver_filter" class="block text-sm font-medium text-gray-700 mb-1">Driver</label>
                <select id="driver_filter" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    <option value="">All Drivers</option>
                    {% for driver in drivers %}
                    <option value="{{ driver.id }}">{{ driver.first_name }} {{ driver.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="vehicle_filter" class="block text-sm font-medium text-gray-700 mb-1">Vehicle</label>
                <select id="vehicle_filter" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    <option value="">All Vehicles</option>
                    {% for vehicle in vehicles %}
                    <option value="{{ vehicle.id }}">{{ vehicle.license_plate }} - {{ vehicle.make }} {{ vehicle.model }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="report_type" class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                <select id="report_type" class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                        onchange="updateReportContent()">
                    <option value="financial_summary">Financial Summary</option>
                    <option value="driver_performance">Driver Performance</option>
                    <option value="vehicle_utilization">Vehicle Utilization</option>
                    <option value="expense_analysis">Expense Analysis</option>
                    <option value="contract_analysis">Contract Analysis</option>
                    <option value="compliance_report">Compliance Report</option>
                </select>
            </div>
        </div>
        
        <div class="flex justify-end mt-4">
            <button onclick="applyFilters()" 
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                Apply Filters
            </button>
        </div>
    </div>

    <!-- Report Content -->
    <div id="report-content">
        <!-- Financial Summary Report (Default) -->
        <div id="financial_summary_report" class="space-y-8">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Revenue</p>
                            <p class="text-2xl font-bold text-gray-900" id="total_revenue">{{ total_revenue | format_currency }}</p>
                            <p class="text-xs text-gray-600 mt-1">{{ revenue_change }}% vs last period</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i data-lucide="trending-down" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                            <p class="text-2xl font-bold text-gray-900" id="total_expenses">{{ total_expenses | format_currency }}</p>
                            <p class="text-xs text-gray-600 mt-1">{{ expenses_change }}% vs last period</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-lucide="activity" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Net Profit</p>
                            <p class="text-2xl font-bold text-gray-900" id="net_profit">{{ net_profit | format_currency }}</p>
                            <p class="text-xs text-gray-600 mt-1">{{ profit_margin }}% margin</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i data-lucide="car" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Trips</p>
                            <p class="text-2xl font-bold text-gray-900" id="total_trips">{{ total_trips | default('0') }}</p>
                            <p class="text-xs text-gray-600 mt-1">{{ avg_revenue_per_trip | format_currency }} per trip</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue vs Expenses Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Revenue vs Expenses Trend</h3>
                    <div class="flex space-x-2">
                        <button onclick="updateChart('monthly')" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200">Monthly</button>
                        <button onclick="updateChart('weekly')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Weekly</button>
                        <button onclick="updateChart('daily')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Daily</button>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="financialTrendChart"></canvas>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Drivers -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Performing Drivers</h3>
                    <div class="space-y-3">
                        {% for driver in top_drivers %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                    {{ loop.index }}
                                </div>
                                <div class="ml-3">
                                    <p class="font-medium text-gray-900">{{ driver.name }}</p>
                                    <p class="text-sm text-gray-600">{{ driver.trips }} trips</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-gray-900">{{ driver.revenue | format_currency }}</p>
                                <p class="text-sm text-green-600">+{{ driver.growth }}%</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Expense Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Breakdown</h3>
                    <div class="h-64">
                        <canvas id="expenseBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other report types (hidden by default) -->
        <div id="driver_performance_report" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Driver Performance Analysis</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trips</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg/Trip</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Efficiency</th>
                            </tr>
                        </thead>
                        <tbody id="driver-performance-data" class="bg-white divide-y divide-gray-200">
                            <!-- Data populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vehicle_utilization_report" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Vehicle Utilization Analysis</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="h-64">
                        <canvas id="vehicleUtilizationChart"></canvas>
                    </div>
                    <div class="space-y-4">
                        <div id="vehicle-stats">
                            <!-- Vehicle statistics populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="expense_analysis_report" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Expense Analysis</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="h-64">
                        <canvas id="expenseTrendChart"></canvas>
                    </div>
                    <div class="h-64">
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">This Period</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Period</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="expense-analysis-data" class="bg-white divide-y divide-gray-200">
                            <!-- Data populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Export Report</h3>
                <p class="text-sm text-gray-600">Download this report in various formats</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportReport('pdf')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>PDF
                </button>
                <button onclick="exportReport('excel')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>Excel
                </button>
                <button onclick="exportReport('csv')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>CSV
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let financialTrendChart, expenseBreakdownChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadReportData();
});

function initializeCharts() {
    // Financial Trend Chart
    const financialCtx = document.getElementById('financialTrendChart').getContext('2d');
    financialTrendChart = new Chart(financialCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4
            }, {
                label: 'Expenses',
                data: [],
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('sv-SE', {
                                style: 'currency',
                                currency: 'SEK'
                            }).format(value);
                        }
                    }
                }
            }
        }
    });

    // Expense Breakdown Chart
    const expenseCtx = document.getElementById('expenseBreakdownChart').getContext('2d');
    expenseBreakdownChart = new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
            labels: ['Fuel', 'Maintenance', 'Insurance', 'Other'],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgb(239, 68, 68)',
                    'rgb(245, 158, 11)',
                    'rgb(59, 130, 246)',
                    'rgb(107, 114, 128)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updateDateRange() {
    const range = document.getElementById('date_range').value;
    const startField = document.getElementById('custom_date_start');
    const endField = document.getElementById('custom_date_end');
    
    if (range === 'custom') {
        startField.classList.remove('hidden');
        endField.classList.remove('hidden');
    } else {
        startField.classList.add('hidden');
        endField.classList.add('hidden');
    }
}

function updateReportContent() {
    const reportType = document.getElementById('report_type').value;
    
    // Hide all reports
    document.querySelectorAll('[id$="_report"]').forEach(el => el.classList.add('hidden'));
    
    // Show selected report
    document.getElementById(reportType + '_report').classList.remove('hidden');
    
    // Load data for the selected report
    loadReportData(reportType);
}

function loadReportData(reportType = 'financial_summary') {
    const filters = {
        date_range: document.getElementById('date_range').value,
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        driver_filter: document.getElementById('driver_filter').value,
        vehicle_filter: document.getElementById('vehicle_filter').value,
        report_type: reportType
    };

    fetch('/api/advanced-reports', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
        updateReportDisplay(data, reportType);
    })
    .catch(error => console.error('Error loading report data:', error));
}

function updateReportDisplay(data, reportType) {
    switch(reportType) {
        case 'financial_summary':
            updateFinancialSummary(data);
            break;
        case 'driver_performance':
            updateDriverPerformance(data);
            break;
        case 'vehicle_utilization':
            updateVehicleUtilization(data);
            break;
        case 'expense_analysis':
            updateExpenseAnalysis(data);
            break;
    }
}

function updateFinancialSummary(data) {
    // Update metrics
    document.getElementById('total_revenue').textContent = formatCurrency(data.total_revenue || 0);
    document.getElementById('total_expenses').textContent = formatCurrency(data.total_expenses || 0);
    document.getElementById('net_profit').textContent = formatCurrency(data.net_profit || 0);
    document.getElementById('total_trips').textContent = data.total_trips || 0;
    
    // Update charts
    if (data.trend_data) {
        financialTrendChart.data.labels = data.trend_data.labels;
        financialTrendChart.data.datasets[0].data = data.trend_data.revenue;
        financialTrendChart.data.datasets[1].data = data.trend_data.expenses;
        financialTrendChart.update();
    }
    
    if (data.expense_breakdown) {
        expenseBreakdownChart.data.datasets[0].data = data.expense_breakdown.values;
        expenseBreakdownChart.data.labels = data.expense_breakdown.labels;
        expenseBreakdownChart.update();
    }
}

function applyFilters() {
    const reportType = document.getElementById('report_type').value;
    loadReportData(reportType);
}

function resetFilters() {
    document.getElementById('date_range').value = 'this_month';
    document.getElementById('driver_filter').value = '';
    document.getElementById('vehicle_filter').value = '';
    document.getElementById('report_type').value = 'financial_summary';
    updateDateRange();
    updateReportContent();
}

function exportReport(format) {
    const filters = {
        date_range: document.getElementById('date_range').value,
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        driver_filter: document.getElementById('driver_filter').value,
        vehicle_filter: document.getElementById('vehicle_filter').value,
        report_type: document.getElementById('report_type').value,
        format: format
    };

    const queryString = new URLSearchParams(filters).toString();
    window.open(`/reports/export?${queryString}`, '_blank');
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('sv-SE', {
        style: 'currency',
        currency: 'SEK',
        minimumFractionDigits: 0
    }).format(amount);
}
</script>
{% endblock %}